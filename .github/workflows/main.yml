name: Music_App Deployment

on:
  push:
    branches: 
      - main  

  pull_request:
    branches: 
      - main
  
  workflow_dispatch:

concurrency:
  group: "music-app"
  cancel-in-progress: false

env:
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.12.2

jobs:
  build:
    runs-on: ubuntu-latest  # ✅ FIXED

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install PyQt6 & System Dependencies  # ✅ FIXED
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || pip install PyQt6
        sudo apt-get update && sudo apt-get install -y libxcb-xinerama0

    - name: Setup Database
      run: |
        python -c "import os;
        database_dir = os.path.abspath(os.path.join(os.getcwd(), '.dbs'));
        app_database = os.path.join(database_dir, 'app_db.db');
        if not os.path.exists(database_dir):
            print(f'Creating database directory at: {database_dir}');
            os.makedirs(database_dir);
        if not os.path.exists(app_database):
            print(f'Creating new database file at: {app_database}');
        else:
            print(f'Database file already exists at: {app_database}');"

    - name: Run Application
      run: python run.py  # ✅ FIXED
